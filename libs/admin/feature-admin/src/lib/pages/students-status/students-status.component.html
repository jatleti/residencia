<div class="p-1 md:p-1">
    <p-card>
        <div class="flex gap-3 justify-between w-full p-5 px-8">
            <components-h1 class="mb-5 block text-primary-500 text-center md:text-start"
                >Usuarios en el centro</components-h1
            >
            <div *ngIf="isPermitted([Permissions.STUDENT.LIST])" class="flex-0">
                <button (click)="init()" pButton pRipple type="button">
                    <i class="fa-sharp fa-solid fa-refresh me-2"></i> Actualizar
                </button>
            </div>
        </div>
        <div class="flex items-center p-1">
            <div class="flex-1 w-full shadow-sm rounded-md">
                <p-tabs [(value)]="tabIndex" scrollable class="w-full">
                    <p-tablist class="w-full grid">
                        <p-tab [value]="0" class="flex gap-2 items-center">Bloque 1</p-tab>
                        <p-tab [value]="1" class="flex gap-2 items-center">Bloque 2</p-tab>
                        <p-tab [value]="2" class="flex gap-2 items-center">Bloque 3</p-tab>
                        <p-tab [value]="3" class="flex gap-2 items-center">Bloque 4</p-tab>
                        <p-tab [value]="4" class="flex gap-2 items-center">Bloque 5</p-tab>
                    </p-tablist>
                    <p-tabpanels>
                        <p-tabpanel [value]="0">
                            <div class="mb-5 grid grid-cols-3 gap-1">
                                <ng-container
                                    *ngTemplateOutlet="blockTemplate; context: { $implicit: block1 }"
                                ></ng-container>
                            </div>
                        </p-tabpanel>
                        <p-tabpanel [value]="1">
                            <div class="mb-5 grid grid-cols-3 gap-1">
                                <ng-container
                                    *ngTemplateOutlet="blockTemplate; context: { $implicit: block2 }"
                                ></ng-container>
                            </div>
                        </p-tabpanel>
                        <p-tabpanel [value]="2">
                            <div class="mb-5 grid grid-cols-3 gap-1">
                                <ng-container
                                    *ngTemplateOutlet="blockTemplate; context: { $implicit: block3 }"
                                ></ng-container>
                            </div>
                        </p-tabpanel>
                        <p-tabpanel [value]="3">
                            <div class="mb-5 grid grid-cols-3 gap-1">
                                <ng-container
                                    *ngTemplateOutlet="blockTemplate; context: { $implicit: block4 }"
                                ></ng-container>
                            </div>
                        </p-tabpanel>
                        <p-tabpanel [value]="4">
                            <div class="mb-5 grid grid-cols-3 gap-1">
                                <ng-container
                                    *ngTemplateOutlet="blockTemplate; context: { $implicit: block5 }"
                                ></ng-container>
                            </div>
                        </p-tabpanel>
                    </p-tabpanels>
                </p-tabs>

                <!-- Template reutilizable para todos los bloques -->
                <ng-template #blockTemplate let-block>
                    <div *ngFor="let room of block.rooms" class="flex flex-col">
                        <div class="font-bold text-center bg-blue-200 w-full rounded-md">Hab: {{ room.room }}</div>
                        <div class="grid grid-cols-4 gap-1 items-center bg-gray-50 rounded-md">
                            <div *ngFor="let bed of room.beds" class="text-center font-bold text-xl">
                                <ng-container *ngIf="bed.student; else noStudent">
                                    <div
                                        (click)="viewStudent(bed.student)"
                                        [pTooltip]="bed.student.name + ' ' + bed.student.surname"
                                        tooltipPosition="top"
                                        class="image flex items-center max-w-[200px] mx-auto mb-3 aspect-square overflow-hidden rounded-md border-4 cursor-pointer relative"
                                        [class.border-green-500]="
                                            bed.student.Attendances &&
                                            bed.student.Attendances.length > 0 &&
                                            bed.student.Attendances[0].type === attendanceTypes.ARRIVE
                                        "
                                        [class.border-red-500]="
                                            bed.student.Attendances &&
                                            bed.student.Attendances.length > 0 &&
                                            bed.student.Attendances[0].type === attendanceTypes.LEAVE
                                        "
                                    >
                                        <img
                                            *ngIf="bed.student.photo && bed.student.photo !== ''"
                                            src="{{ bed.student.photo }}"
                                        />
                                        <div class="absolute bottom-0 left-0 right-0 w-full">
                                            <div
                                                *ngIf="
                                                    bed.student.Attendances &&
                                                    bed.student.Attendances.length > 0 &&
                                                    bed.student.Attendances[0].type === attendanceTypes.ARRIVE
                                                "
                                                class="bg-green-500 text-white text-sm"
                                            >
                                                <!-- <div class="bg-opacity-50 text-white text-sm p-1">
                                                    {{ bed.student.name }} {{ bed.student.surname }}
                                                </div> -->
                                                RESIDENCIA
                                            </div>
                                            <div
                                                *ngIf="
                                                    bed.student.Attendances &&
                                                    bed.student.Attendances.length > 0 &&
                                                    bed.student.Attendances[0].type === attendanceTypes.LEAVE &&
                                                    bed.student.Attendances[0].subtype === attendanceSubTypes.HOME
                                                "
                                                class="bg-red-500 text-white text-sm"
                                            >
                                                <!-- <div class="bg-opacity-50 text-white text-sm p-1">
                                                    {{ bed.student.name }} {{ bed.student.surname }}
                                                </div> -->
                                                EN DOMICILIO
                                            </div>
                                            <div
                                                *ngIf="
                                                    bed.student.Attendances &&
                                                    bed.student.Attendances.length > 0 &&
                                                    bed.student.Attendances[0].type === attendanceTypes.LEAVE &&
                                                    bed.student.Attendances[0].subtype === attendanceSubTypes.WALK
                                                "
                                                class="bg-red-500 text-white text-sm"
                                            >
                                                <!-- <div class="bg-opacity-50 text-white text-sm p-1">
                                                    {{ bed.student.name }} {{ bed.student.surname }}
                                                </div> -->
                                                DE PASEO
                                            </div>
                                            <div
                                                *ngIf="
                                                    bed.student.Attendances &&
                                                    bed.student.Attendances.length > 0 &&
                                                    bed.student.Attendances[0].type === attendanceTypes.LEAVE &&
                                                    bed.student.Attendances[0].subtype === attendanceSubTypes.TRAINING
                                                "
                                                class="bg-red-500 text-white text-sm"
                                            >
                                                <!-- <div class="bg-opacity-50 text-white text-sm p-1">
                                                    {{ bed.student.name }} {{ bed.student.surname }}
                                                </div> -->
                                                ENTRENAMIENTO
                                            </div>
                                            <div
                                                *ngIf="
                                                    bed.student.Attendances &&
                                                    bed.student.Attendances.length > 0 &&
                                                    bed.student.Attendances[0].type === attendanceTypes.LEAVE &&
                                                    bed.student.Attendances[0].subtype === attendanceSubTypes.AUTHORIZED
                                                "
                                                class="bg-red-500 text-white text-sm"
                                            >
                                                <!-- <div class="bg-opacity-50 text-white text-sm p-1">
                                                    {{ bed.student.name }} {{ bed.student.surname }}
                                                </div> -->
                                                SAL. AUTORIZADA
                                            </div>
                                        </div>
                                        <div
                                            class="absolute top-0 left-0 bg-yellow-500 text-black text-sm p-1 rounded-br-md"
                                        >
                                            {{ bed.student.code }}
                                        </div>
                                        <div
                                            *ngIf="getAgeNumber(bed.student.birthdate || null) < 18"
                                            class="absolute top-0 right-0 bg-yellow-500 text-black text-sm p-1 rounded-bl-md"
                                        >
                                            Menor
                                        </div>
                                    </div>
                                </ng-container>
                            </div>
                        </div>
                    </div>
                </ng-template>

                <ng-template #noStudent>
                    <div
                        class="image flex items-center max-w-[200px] mx-auto mb-3 aspect-square overflow-hidden rounded-md border-8 cursor-pointer"
                    >
                        <img src="/assets/img/dummy.jpg" />
                    </div>
                </ng-template>
            </div>
        </div>
    </p-card>
</div>
